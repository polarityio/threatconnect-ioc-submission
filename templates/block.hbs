{{!-- modal-open sets a minimum height so our absolute positioned modal is always visible --}}
<div class="{{if showDeletionModal "modal-open"}}">
  <div class="modal-mask {{if showDeletionModal "visible" "invisible"}}"></div>
  
  {{#if showDeletionModal}}
    <div class="integration-modal">
      <div class="title">
        <div class="content">
          Delete IOC
        </div>      
      </div>
      <div class="content">
        <span class="p-key">
          <div>
            {{fa-icon icon="exclamation-triangle" fixedWidth=true class="p-red"}} You are about to delete the indicator <b>{{resultToDelete.entity.value}}</b> from the organization <b>{{details.myOwner.name}}</b>
          </div>
          <div class="mt-2">
             Deleting an indicator cannot be undone and will remove all data for the indicator from the ThreatConnect platform.
          </div>
        </span>
      </div>
      <div class="footer">
        <div class="content d-flex align-items-center justify-content-end">
          <button class="btn btn-naked p-btn short outline" {{action "cancelItemDeletion"}}>
            Cancel
          </button>
          <button
                  class="btn btn-danger p-btn short outline"
            {{action "confirmDelete"}}
          >
            {{#if isDeleting}}
              {{fa-icon icon="spinner-third" fixedWidth=true spin=true}}
            {{else}}
              Delete
            {{/if}}
          </button>
        </div>
      </div>
    </div>
  {{/if}}
  
  {{#if state.errorMessage}}
    <div class="alert alert-danger error-message mt-2">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="error-message-title">
          {{#if state.errorTitle}}
            {{state.errorTitle}}
          {{else}}
            Unexpected Error Occurred
          {{/if}}
        </div>
        <div>
          {{fa-icon icon="times" fixedWidth=true click=(set state "errorMessage" "") class="close-icon"}}
        </div>
      </div>
      <div class="error-scrolling-container">
        <pre>{{state.errorMessage}}</pre>
      </div>
    </div>
  {{/if}}
  
  {{!-- Display results that are in other orgs but not owner's organization --}}
  {{!--
  {{#if hasIndicatorNotInMyOwner}}
    <h1 class="p-title">
      {{fa-icon "info-circle" size="sm"}}
      Found in ThreatConnect but not in {{details.myOwner.name}}
    </h1>
    <table class="w-100">
      <tbody>
      {{#each details.results as | result |}}
        {{#if (and result.foundInThreatConnect (not result.isInMyOwner))}}
          <tr>
            <td>
              <div class="url-column">
                <span>{{result.indicator.ownerName}}</span>
                <div class="owner-row">
                  <a href={{result.indicator.webLink}}>
                    {{result.indicator.summary}}
                    {{fa-icon icon="external-link" fixedWidth=true class="external-link-icon"}}
                  </a>
                  <span class="type">{{result.indicator.type}}</span>
                  {{#if (and block.userOptions.allowDelete result.canDelete)}}
                    <button
                      class="no-style-button delete"
                      {{action "initiateItemDeletion" result}}
                      title="Delete IOC from ThreatConnect"
                      disabled={{interactionDisabled}}
                    >
                      {{fa-icon icon="trash" fixedWidth=true}}
                    </button>
                  {{/if}}
                </div>
              </div>            
            </td>
          </tr>
        {{/if}}
      {{/each}}
      </tbody>
    </table>
  {{/if}}
  --}}
  {{!-- Display results that are found in owner's organization --}}
  {{#if hasIndicatorInMyOwner}}
    <h1 class="p-title">
      Found in ThreatConnect
    </h1>
    {{#each details.results as | result |}}
      {{#if result.foundInThreatConnect}}
        <div class="search-result-container">
          <div class="search-result-header d-flex align-items-center justify-content-between" {{action (toggle "__viewIndicatorDetails" result)}}>
            <div class="d-flex align-items-center justify-content-start">
              <div>
                {{#if result.isInMyOwner}}
                  {{fa-icon icon="home" fixedWidth=true class="p-grey"}}
                  {{bs-tooltip title="This indicator is in your organization"}}
                {{else}}
                  {{fa-icon icon="home" class="fa-blank"}}
                {{/if}}
              </div>
              <div class="ml-1">
                  {{result.entity.value}}
              </div>
            </div>
            <div class="d-flex align-items-center justify-content-end">
              <div class="mr-1">
                  <span class="p-footnote">{{result.displayType}}</span>
              </div>
              <div>
                {{#if (and block.userOptions.allowDelete result.canDelete)}}
                  <button 
                    class="no-style-button delete"
                    {{action "initiateItemDeletion" result}}
                    title="Delete indicator from {{details.myOwner.name}}"
                    disabled={{interactionDisabled}}
                  >
                    {{fa-icon icon="trash" fixedWidth=true}}
                  </button>
                {{/if}}
                {{#unless result.isInMyOwner}}
                  <button
                    class="no-style-button p-action add"
                    {{action (set result "__toBeSubmitted" true)}}
                    disabled={{interactionDisabled}}
                  >
                    {{fa-icon icon="plus" fixedWidth=true}}
                    {{bs-tooltip title="Add indicator to submission list"}}
                  </button>
                {{/unless}}
                {{#if result.__viewIndicatorDetails}}
                  {{fa-icon icon="chevron-up" fixedWidth=true class="p-grey"}}
                {{else}}
                  {{fa-icon icon="chevron-down" fixedWidth=true class="p-grey"}}
                {{/if}}                
              </div>
            </div>
          </div>
          {{#if result.__viewIndicatorDetails}}
            <div class="search-result-content">
              {{#each result.indicators as | indicator |}}
                <div>
                  {{indicator.ownerName}}
                </div>
              {{/each}}
            </div>
          {{/if}}
        </div>
      {{/if}}
    {{/each}}
  {{/if}}
  
  {{!-- Display entities that are not in TC --}}
  {{#if hasIndicatorNotInThreatConnect}}
    <div class="d-flex align-items-center justify-content-between">
      <h1 class="p-title">
        Not in ThreatConnect
      </h1>
      {{#unless hasIndicatorsAvailableToSubmit}}
        <button
          class="no-style-button p-action"
          {{action "addAllCurrentlyInThreatConnectToBeSubmitted"}}
          title="Add all IOCs to Submission List"
          disabled={{interactionDisabled}}
        >
          Add All
        </button>
      {{/unless}}
    </div>
    <table class="w-100">
      <tbody>
        {{#each details.results as | result |}}
          {{#if (and (not result.foundInThreatConnect) (not result.__toBeSubmitted))}}
            <tr>
              <td>
                {{result.entity.value}}
                {{#if result.__isOnExclusionList}}
                  <span class="p-footnote">(exclusion listed)</span>
                {{/if}}
                {{#if result.__hasSubmissionError}}
                  {{#if result.__viewError}}
                    <span class="p-action ml-1" {{action (toggle "__viewError" result)}}>Hide Error {{fa-icon icon="chevron-up" fixedWidth=true}}</span>
                  {{else}}
                    <span class="p-action ml-1" {{action (toggle "__viewError" result)}}>View Error {{fa-icon icon="chevron-down" fixedWidth=true}}</span>
                  {{/if}}
                {{/if}}
              </td>
              <td class="type">
                <span>{{result.displayType}}</span>
              </td>
              <td class="icon">
                {{#if result.__isOnExclusionList}}
                  <div>
                    {{fa-icon icon="empty-set" fixedWidth=true class="p-orange"}}
                    {{bs-tooltip title="This indicator is contained on a system-wide exclusion list and cannot be submitted"}}
                  </div>                  
                {{else}}
                  <div class="d-flex align-items-center justify-content-end">
                    {{#if result.__hasSubmissionError}}
                      <div class="mr-1">
                        {{fa-icon icon="exclamation-triangle" fixedWidth=true class="p-red"}}
                        {{bs-tooltip title="An error was encountered submitting this indicator"}}
                      </div>
                    {{/if}}
                    <button
                      class="no-style-button p-action add"
                      {{action (set result "__toBeSubmitted" true)}}
                      title="Add IOC to Submission List"
                      disabled={{interactionDisabled}}
                    >
                      {{fa-icon icon="plus" fixedWidth=true}}
                    </button>
                  </div>
                {{/if}}                
              </td>
            </tr>     
            {{#if result.__viewError}}
              <tr>
                <td colspan="3">
                  <div class="alert alert-danger error-message">
                    <div class="error-scrolling-container">
                      <pre>{{result.__errorMessage}}</pre>
                    </div>
                  </div>
                </td>
              </tr>
            {{/if}}
          {{/if}}
        {{/each}}
      </tbody>
    </table>
    {{#if notInThreatConnectIsEmpty}}
      <div class="note">
        <span class="p-key"><em>NONE</em></span>
      </div>
    {{/if}}
  {{/if}}
  
  {{!-- Display entities that are to be submitted --}}
  {{#unless allIndicatorsInMyOwner}}
    <div class="d-flex align-items-center justify-content-between">
      <h1 class="p-title">
        Submit to ThreatConnect
      </h1>
      {{#if hasIndicatorToBeSubmitted}}
        <button 
          class="no-style-button p-action"
          title="Remove all IOCs from Submission List"
          {{action "removeAllToBeSubmitted"}}
          disabled={{interactionDisabled}}
        >
          Remove All
        </button>
      {{/if}}
    </div>
    {{#if (not hasIndicatorToBeSubmitted)}}
      <div class="note">
          <span class="p-key"><em>NONE</em></span>
      </div>
    {{/if}}
    <table class="w-100">
      <tbody>
      {{#each details.results as | result |}}
        {{#if result.__toBeSubmitted}}
          <tr>
            <td>
              {{result.entity.value}}
            </td>
            <td class="type">
              {{result.entity.displayType}}
            </td>
            <td class="icon">
              <button 
                class="no-style-button p-action"
                title="Remove IOC from Submission List"
                {{action (set result "__toBeSubmitted" false)}}
                disabled={{interactionDisabled}}
              >
                {{fa-icon "minus" fixedWidth=true}}
              </button>
            </td>
          </tr>
        {{/if}}
      {{/each}}
      </tbody>
    </table>
  {{/unless}}
  
  {{!-- Show submision options --}}
  {{#if hasIndicatorToBeSubmitted}}
    <h1 class="p-title">
      Submission Options
    </h1>
    {{!-- Owner Select --}}
    <div class="input-container">
      <label class="small ifta-label">
        Owner
      </label>
      {{#if ownersWithCreatePermission.length}}
        {{#power-select
                eventType="click"
                rootEventType="click"
                triggerClass="ifta-field p-power-select-trigger"
                dropdownClass="p-power-select-dropdown"
                selected=owner
                options=ownersWithCreatePermission
                searchEnabled=true
                searchField="name"
                placeholder="Select owner"
                closeOnSelect=true
                disabled=interactionDisabled
                onChange=(action (mut owner))
        as |owner|
        }}
          {{owner.name}} ({{owner.type}})
        {{/power-select}}
      {{/if}}
    </div>
  
    {{!-- Title Input --}}
    <div class="input-container">
      <label class="small ifta-label">
        Title
        <span class="required">*</span>
      </label>
      {{input
              class=(concat "ifta-field" (if uiElement.error " error"))
              value=title
              placeholder="Enter a title"
              disabled=interactionDisabled
              required=true
      }}
    </div>
  
    {{!-- Description Input --}}
    <div class="input-container text-area-container {{if interactionDisabled "disabled"}} {{if uiElement.error "error"}}">
      <label class="small">
        Description
      </label>
      {{textarea
              class="ifta-field"
              rows=5
              placeholder="Enter a description"
              value=description
              disabled=interactionDisabled
              required=false
      }}
    </div>
  
    {{!-- Source Input --}}
    <div class="input-container">
      <label class="small ifta-label">
        Source
      </label>
      {{input
              class=(concat "ifta-field" (if uiElement.error " error"))
              value=source
              placeholder="Enter a source"
              disabled=interactionDisabled
              required=false
      }}
    </div>
  
    {{!-- Rating --}}
    <div class="mb-2">
      <div class="p-key">Rating &nbsp;</div>
      <div>
        {{fa-icon "ban" click=(action "setRating" 0) class="rating-icon"}}
        {{#each (repeat 5) as |empty ratingIndex|}}
          {{fa-icon
                  "skull"
                  class=(if
                          (lt ratingIndex rating)
                          "rating-icon rating-icon-filled"
                          "rating-icon rating-icon-empty"
                  )
                  click=(action "setRating" (inc ratingIndex))
          }}
        {{/each}}
        {{ratingHuman}}
      </div>
    </div>
  
    {{!-- Confidence Slider --}}
    <div class="confidence">
      <span class="p-key">Confidence: &nbsp;</span>
      <span class="p-value">{{confidence}} - {{confidenceHuman}}</span>
      <div>
        <input
                type="range"
                oninput={{action "setConfidence" value="target.value"}}
                min="0"
                max="100"
                value={{confidence}}
                steps="1"
        />
      </div>
    </div>
  
    {{!-- Associated Groups --}}
    {{#if block.userOptions.allowAssociation}}
      <div class="d-flex align-items-center justify-content-start">
        <h1 class="p-title align-self-baseline">
          Associated Groups
        </h1>
        {{#unless (or editingGroups interactionDisabled)}}
          <button class="btn icon-btn p-action align-self-baseline" {{action (pipe-action (action "initializeGroupFilter")(toggle "editingGroups" this))}} title="Edit Groups">
            {{fa-icon icon="plus-circle" fixedWidth=true}} Edit Groups
          </button>
        {{/unless}}
      </div>
      {{#if (eq selectedGroups.length 0)}}
        <div class="p-footnote">
          No Associated Groups
        </div>
      {{else}}
        {{#each selectedGroups as |group groupIndex|}}
          <div class="associated-group-container">
            <div class="d-flex align-items-start justify-content-between">
              <div class="mr-1">
                {{group.name}}
              </div>
              {{#if (not interactionDisabled)}}
                <div class="remove-icon" {{action "removeGroup" group}}>
                  {{fa-icon "times" class="tag-close-icon" fixedWidth=true}}
                </div>
              {{/if}}
            </div>
            <div class="p-footnote">
              <div>Owner: {{group.ownerName}}</div>
              <div>Type: {{group.type}}</div>
            </div>
          </div>
        {{/each}}
      {{/if}}
      {{#if editingGroups}}
        <div class="add-container mt-2">
          <div class="d-flex align-items-center justify-content-between mb-1 mt-1">
            <h2 class="p-title m-0">
              Add Associated Groups
            </h2>
            <div class="p-action mr-1" {{action (toggle "viewGroupFilters" this)}}>
              {{#if viewGroupFilters}}
                Hide filters
                {{fa-icon icon="chevron-up" fixedWidth=true}}
              {{else}}
                View filters
                {{fa-icon icon="chevron-down" fixedWidth=true}}
              {{/if}}
            </div>
          </div>
          <div class="d-flex align-items-center justify-content-start mb-2">
            <div class="p-footnote">
              {{#if (gt ownerFilter.length 0)}}
                {{ownerFilter.length}} owner {{pluralize ownerFilter.length "filter" without-count=true}}
              {{else}}
                No owner filters applied
              {{/if}}
            </div>
            <div class="p-footnote ml-1 mr-1">|</div>
            <div class="p-footnote">
              {{#if (gt groupTypeFilter.length 0)}}
                {{groupTypeFilter.length}} group type {{pluralize groupTypeFilter.length "filter" without-count=true}}
              {{else}}
                No group type filters applied
              {{/if}}
            </div>
          </div>
          {{#if viewGroupFilters}}
            <div class="group-filter-container mb-2">
              <h3 class="p-title mb-2 mt-1">
                Group Search Filters
              </h3>
              <div class="input-container mb-2">
                <label class="small ifta-label">
                  Owner Filter
                </label>
                {{#power-select-multiple
                        eventType="click"
                        rootEventType="click"
                        triggerClass="p-power-select-multiple-trigger"
                        dropdownClass="p-power-select-dropdown"
                        selected=ownerFilter
                        options=ownersWithCreatePermission
                        searchEnabled=true
                        placeholder="No owner filter applied"
                        closeOnSelect=true
                        disabled=interactionDisabled
                        onChange=(action (mut ownerFilter))
                as |owner|
                }}
                  {{owner.name}} ({{owner.type}})
                {{/power-select-multiple}}
              </div>
  
              <div class="input-container mb-2">
                <label class="small ifta-label">
                  Group Type Filter
                </label>
                {{#power-select-multiple
                        eventType="click"
                        rootEventType="click"
                        triggerClass="p-power-select-multiple-trigger"
                        dropdownClass="p-power-select-dropdown"
                        selected=groupTypeFilter
                        options=groupTypeNames
                        searchEnabled=true
                        placeholder="No group type filter applied"
                        closeOnSelect=true
                        disabled=interactionDisabled
                        onChange=(action (mut groupTypeFilter))
                as |groupType|
                }}
                  {{groupType}}
                {{/power-select-multiple}}
              </div>
            </div>
          {{/if}}
          <div class="input-container">
            <label class="small ifta-label">
              Associated Group
            </label>
            {{#if searchingGroups}}
              <div class="p-power-select-searching-icon-container">
                {{fa-icon icon="spinner-third" spin=true fixedWidth=true class="p-power-select-searching-icon"}}
                loading
              </div>
            {{/if}}
  
            {{#power-select
                    eventType="click"
                    rootEventType="click"
                    triggerClass="ifta-field p-power-select-trigger"
                    dropdownClass="p-power-select-dropdown"
                    searchEnabled=true
                    search=(action "searchGroups")
                    searchMessage="No groups match filter criteria"
                    loadingMessage="Loading groups ..."
                    selected=selectedGroup
                    options=groups
                    searchField="name"
                    placeholder="Select associated group"
                    closeOnSelect=true
                    disabled=interactionDisabled
                    onOpen=(action "initializeGroupFilter")
                    onChange=(action (mut selectedGroup))
            as |group|
            }}
              {{group.name}} ({{group.ownerName}})
            {{/power-select}}
          </div>
          <div class="d-flex align-items-center justify-content-end mb-1">
            <button
                    class="btn btn-naked p-btn short outline"
              {{action (toggle "editingGroups" this)}}
                    disabled={{interactionDisabled}}
            >
              Close
            </button>
            <button
                    class="btn btn-polarity p-btn short outline"
              {{action "addGroup"}}
                    disabled={{interactionDisabled}}
            >
              Add Group
            </button>
          </div>
        </div>
      {{/if}}
    {{/if}}
  
    {{!-- Host Specific Options --}}
    {{#if entitiesToSubmitIncludeDomain}}
      <h1 class="p-title">
        Host Specific Options
      </h1>
      <div class="checkbox-container">
        <label class="d-flex align-items-center">
          <input
                  type="checkbox"
            {{on "change" (action (mut whoisActive) value="target.checked")}}
                  disabled={{interactionDisabled}}
          />
          <span class="p-value ml-1">Enable Whois Lookups</span>
        </label>
      </div>
      <div class="checkbox-container">
        <label class="d-flex align-items-center">
          <input
                  type="checkbox"
            {{on "change" (action (mut dnsActive) value="target.checked")}}
                  disabled={{interactionDisabled}}
          />
          <span class="p-value ml-1">Enable DNS Tracking</span>
        </label>
      </div>
    {{/if}}
  
    {{!-- Associated Tags --}}
    <div>
      <div class="d-flex align-items-center justify-content-start">
        <h1 class="p-title align-self-baseline">
          Associated Tags
        </h1>
        {{#unless (or editingTags interactionDisabled)}}
          <button class="btn icon-btn p-action align-self-baseline" {{action (toggle "editingTags" this)}} title="Edit Tags">
            {{fa-icon icon="plus-circle" fixedWidth=true}} Edit Tags
          </button>
        {{/unless}}
      </div>
      {{#if (eq selectedTags.length 0)}}
        <div class="p-footnote">
          No Tags
        </div>
      {{else}}
        {{#each selectedTags as |tag tagIndex|}}
          {{#if tag.isNew}}
            <span class="tag link-tag d-inline-flex align-items-center">
                  <span
                          class="text-container threatconnect-summary-tag
                      {{unless interactionDisabled ' rounded-borders'}}"
                  >
                    {{tag.name}}
                    {{#if (not interactionDisabled)}}
                      <span class="remove-icon-container" {{action "deleteTag" tag}}>
                        {{fa-icon "times" class="tag-close-icon" fixedWidth=true}}
                      </span>
                    {{/if}}
                  </span>
                </span>
          {{else}}
            <a
                    href="{{details.uiUrl}}/auth/tags/tag.xhtml?tag={{tag.name}}&owner={{details.owner.name}}"
            class="tag link-tag d-inline-flex align-items-center"
            >
            <span
                    class="text-container threatconnect-summary-tag
                      {{unless interactionDisabled ' rounded-borders'}}"
            >
                    {{tag.name}}
              {{#if (not interactionDisabled)}}
                <span class="remove-icon-container" {{action "deleteTag" tag}}>
                  {{fa-icon "times" class="tag-close-icon" fixedWidth=true}}
                </span>
              {{/if}}
                  </span>
            </a>
          {{/if}}
        {{/each}}
      {{/if}}
  
      {{#if editingTags}}
        <div class="add-container mt-2">
          <div class="input-container mb-2">
            <label class="small ifta-label">
              Select Tags to Add
            </label>
            {{#power-select-multiple
                    eventType="click"
                    rootEventType="click"
                    triggerClass="p-power-select-multiple-trigger"
                    dropdownClass="p-power-select-dropdown"
                    selected=selectedTag
                    options=existingTags
                    searchEnabled=true
                    search=(action "searchTags")
                    placeholder="Search Tags"
                    searchField="name"
                    searchMessage="Loading Tags ..."
                    loadingMessage="Loading Tags ..."
                    searchPlaceholder="Search tags"
                    closeOnSelect=true
                    disabled=interactionDisabled
                    onOpen=(action "searchTags" "")
                    onChange=(action (mut selectedTag))
            as |tag|
            }}
              <span class="p-tag"
                    style="display: inline-block;
                          font-weight: normal;
                          word-break: break-word;
                          line-height: 1.2em;
                          font-size: 12px;
                          background-color: #fff;
                          border: 1px solid #e4e9f2;
                          padding: 2px 10px;
                          border-radius: 16px;
                          margin: 0px;
                          color: #07213a;"
              >
                    {{#if tag.techniqueId}}
                      &#38;
                      {{tag.techniqueId}}
                      -
                    {{/if}}
                {{tag.name}}
                <span style="position: relative;">
                  {{#if tag.isNew}}
                    {{fa-icon "plus-circle" fixedWidth=true}}
                  {{/if}}
                </span>
                  </span>
            {{/power-select-multiple}}
          </div>
          <div class="d-flex align-items-center justify-content-end mb-1 mt-2">
            <button
              class="btn btn-naked p-btn short outline"
              {{action (toggle "editingTags" this)}}
              disabled={{interactionDisabled}}
            >
              Cancel
            </button>
            <button
              class="btn btn-polarity p-btn short outline"
              {{action "addTags"}}
              disabled={{interactionDisabled}}
            >
              Add Tags
            </button>
          </div>
        </div>
      {{/if}}
    </div>
  
    <div class="d-flex flex-row-reverse justify-content-between align-items-center mt-2">
      <button
        class="btn btn-polarity p-btn"
        {{action "submitItems"}}
        disabled={{interactionDisabled}}
      >
        {{#if createIsRunning}}
          {{fa-icon icon="spinner-third" spin=true fixedWidth=true}}
        {{else}}
          Submit IOCs
        {{/if}}
      </button>
  
      {{#if createErrorMessage}}
        <div class="create-message alert alert-danger m-0">
          {{createErrorMessage}}
        </div>
      {{/if}}
    </div>  
  {{/if}}
</div>